<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supply Chain Sentinel</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+Thai:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans Thai', sans-serif;
            background-color: #171717; /* Very dark background */
            padding: 10px; /* Adjusted padding for better mobile fit */
            min-height: 100vh;
            color: #ffffff; /* Default text color set to white */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Aligns content to top initially */
        }

        /* Gradient for the main button */
        .deep-blue-purple-gradient {
            /* Dark Gray Metallic Gradient */
            background: linear-gradient(135deg, #374151, #1F2937);
        }

        /* Style for dark mode input fields */
        .dark-input {
            background-color: #1f2937; /* Darker input background */
            border-color: #374151; /* Gray border */
            color: #ffffff;
            transition: all 0.2s;
        }
        .dark-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.5);
            border-color: #6b7280;
        }
        
        /* Custom class for displaying error/warning prominently */
        .warning-box {
            background-color: #3c1e1e; /* Dark Red Background */
            color: #fca5a5; /* Light Red Text */
            border: 1px solid #dc2626; /* Red Border */
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        /* Ensures smooth transition for details and conditions toggle */
        .toggle-container {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            padding: 0 1rem;
        }

        .toggle-container.active {
            max-height: 2000px; /* ADJUSTED: Increased max-height to ensure all content fits on mobile */
            opacity: 1;
            padding: 1rem;
            margin-top: 1rem; 
        }

        /* Footer positioning */
        #app-footer {
            margin-top: 40px;
            padding: 10px;
            font-size: 0.8rem;
            color: #6b7280;
        }
    </style>
</head>
<body>

    <!-- INVENTORY CALCULATION SECTION -->
    <!-- Adjusted padding for better mobile fit: p-4 sm:p-6 md:p-8 -->
    <div class="max-w-4xl mx-auto mt-2 bg-gray-900 text-white p-4 sm:p-6 md:p-8 rounded-2xl shadow-2xl border border-gray-700 w-full"> 
        <h2 class="text-2xl font-bold mb-6 border-b border-gray-700 pb-2 text-center">
            คำนวณจุดสั่งซื้อสินค้า
        </h2>
        
        <div class="grid grid-cols-1 gap-6">
            <div>
                <label for="soh" class="block text-sm font-medium text-gray-300">Stock On Hand (SOH - จำนวนสินค้า)</label>
                <!-- Input ID: soh -->
                <input type="number" id="soh" class="mt-1 block w-full p-3 dark-input rounded-lg" placeholder="ตัวอย่าง: 100 หน่วย">
            </div>
            <div>
                <label for="usage" class="block text-sm font-medium text-gray-300">Usage per Month (ปริมาณการใช้ต่อเดือน)</label>
                <!-- Input ID: usage -->
                <input type="number" id="usage" class="mt-1 block w-full p-3 dark-input rounded-lg" placeholder="ตัวอย่าง: 75 หน่วย/เดือน">
            </div>
            <div>
                <label for="lt" class="block text-sm font-medium text-gray-300">Lead Time (LT - ระยะเวลารอสินค้าปกติ, วัน)</label>
                <!-- Input ID: lt -->
                <input type="number" id="lt" class="mt-1 block w-full p-3 dark-input rounded-lg" placeholder="ตัวอย่าง: 12 วันทำการ">
            </div>
            <div>
                <label for="bufferLt" class="block text-sm font-medium text-gray-300">Buffer LT (เผื่อการจัดส่ง/อนุมัติช้า, วัน) (ไม่บังคับ)</label>
                <!-- Input ID: bufferLt -->
                <input type="number" id="bufferLt" class="mt-1 block w-full p-3 dark-input rounded-lg" placeholder="ตัวอย่าง: 5 วัน (ถ้ามี)">
            </div>
        </div>

        <button onclick="calculateReorder()" class="w-full mt-6 p-4 deep-blue-purple-gradient text-white font-bold text-lg rounded-xl transition-shadow shadow-lg hover:shadow-xl">
            คำนวณจุดสั่งซื้อ
        </button>

        <!-- Results Display -->
        <div id="results" class="mt-8 p-4 sm:p-6 bg-gray-800 rounded-xl border border-gray-700 hidden">
            <h3 class="text-xl font-bold text-white mb-4">ผลการคำนวณ:</h3>
            
            <!-- Main Grid Results: grid-cols-2 ensures good stacking on small screens -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4">
                <div class="p-3 bg-gray-900 rounded-lg border-l-4 border-red-500">
                    <p class="text-xs text-gray-400">Total Month ปัจจุบัน</p>
                    <p class="text-xl font-extrabold text-red-400" id="totalMonthCurrent"></p>
                </div>
                <div class="p-3 bg-gray-900 rounded-lg border-l-4 border-cyan-500">
                    <p class="text-xs text-gray-400">ปริมาณสั่งซื้อ (หน่วย)</p>
                    <p class="text-xl font-extrabold text-cyan-400" id="orderQuantity"></p>
                </div>
                <div class="p-3 bg-gray-900 rounded-lg border-l-4 border-yellow-500">
                    <p class="text-xs text-gray-400">วันสั่งซื้อสินค้าที่แนะนำ</p>
                    <!-- UPDATED SIZE AND WEIGHT -->
                    <p class="text-xl font-extrabold text-yellow-400" id="orderDate"></p>
                </div>
                <div class="p-3 bg-gray-900 rounded-lg border-l-4 border-indigo-500">
                    <p class="text-xs text-gray-400">วันส่งสินค้าที่คาดหวัง</p>
                    <!-- UPDATED SIZE AND WEIGHT -->
                    <p class="text-xl font-extrabold text-indigo-400" id="deliveryDate"></p>
                </div>
            </div>
            
            <!-- Combined Total Month After Delivery and Buttons -->
            <div class="mt-4 p-4 bg-gray-900 rounded-lg border-l-4 border-green-500 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                <!-- Text Display (Total Month After Delivery) -->
                <div class="w-full sm:w-auto">
                    <p class="text-sm text-gray-400">Total Month หลังส่งสินค้า (เป้าหมาย <span id="targetMonthDisplay" class="font-bold"></span> เดือน)</p>
                    <p class="text-3xl font-extrabold text-green-400" id="postDeliveryMonth"></p>
                </div>
                <!-- Buttons Container: w-full ensures buttons use full width on mobile if they stack -->
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <!-- NEW BUTTON: Add/Edit Conditions -->
                    <button id="toggleConditionsBtn" onclick="toggleConditionsModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition-colors flex-shrink-0 w-full sm:w-auto hidden">
                        เพิ่ม/แก้ไข เงื่อนไข
                    </button>
                    
                    <!-- Details Button -->
                    <button id="toggleDetailsBtn" onclick="toggleDetails()" class="px-5 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold rounded-lg transition-colors flex-shrink-0 w-full sm:w-auto hidden">
                        รายละเอียดเพิ่มเติม
                    </button>
                </div>
            </div>

            <!-- Conditions Input Area (Toggled by toggleConditionsModal) -->
            <div id="conditionsModalContainer" class="toggle-container text-sm text-gray-300 bg-gray-900 rounded-lg mt-4 hidden">
                 <label for="noDeliveryDates" class="block text-xs font-medium text-gray-400 mb-1">วันที่ห้ามส่งสินค้า (DD-MM-YYYY คั่นด้วยคอมม่า)</label>
                 <textarea id="noDeliveryDates" onchange="calculateReorder()" rows="3" class="w-full p-2 dark-input rounded-lg text-xs" placeholder="ตัวอย่าง: 25-12-2025, 31-12-2025, 01-01-2026"></textarea>
                 <p class="mt-2 text-red-400 text-xs hidden" id="dateInputError"></p>
                 <p class="mt-2 text-yellow-400 text-xs hidden" id="adjustmentWarning"></p>
            </div>
            
            <!-- Details Container (Toggled by toggleDetails) -->
            <div id="detailMessageContainer" class="toggle-container text-sm text-gray-300 bg-gray-900 rounded-lg hidden">
                <!-- Content will wrap automatically within the container's width -->
                <p id="detailMessage"></p>
            </div>

            <!-- Error/Warning Message Box -->
            <div id="errorMessage" class="warning-box text-sm hidden"></div>
        </div>
    </div>

    <!-- FOOTER SECTION -->
    <footer id="app-footer">
        For test only
    </footer>

    <script>
        // ใช้ 30.4375 วัน เป็นค่าเฉลี่ยของจำนวนวันในหนึ่งเดือน
        const DAYS_PER_MONTH = 30.4375;
        let blockedDates = []; // Global array to store parsed blocked dates

        /**
         * Helper function to format a Date object into DD-MM-YYYY format (Western Year).
         * @param {Date} date - The date object to format.
         * @returns {string} The formatted date string or "N/A".
         */
        function formatDateDDMMYYYY(date) {
            if (!date || isNaN(date.getTime())) return "N/A";
            const d = new Date(date);
            // PadStart ensures 2 digits (e.g., 01, 10)
            const day = String(d.getDate()).padStart(2, '0');
            // getMonth() is 0-indexed, so add 1
            const month = String(d.getMonth() + 1).padStart(2, '0'); 
            const year = d.getFullYear(); // Gets Western year (e.g., 2025)
            return `${day}-${month}-${year}`;
        }
        
        /**
         * Helper function to parse a single DD-MM-YYYY string to Date object.
         * Handles 2-digit year by assuming 20XX.
         * @param {string} dateString - Date in 'DD-MM-YYYY' or 'DD-MM-YY' format.
         * @returns {Date|null} The parsed Date object (normalized to start of day) or null if invalid.
         */
        function parseDate(dateString) {
            const parts = dateString.split(/[-\/.]/); // Allow various separators
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                let year = parseInt(parts[2], 10);
                
                // Simple 2-digit year conversion (assuming 20XX)
                if (year < 100) {
                    year += 2000;
                }

                const date = new Date(year, month, day);
                date.setHours(0, 0, 0, 0); // Normalize time
                
                // Basic validation: ensure the constructed date matches the input parts
                if (date.getFullYear() === year && date.getMonth() === month && date.getDate() === day) {
                    return date;
                }
            }
            return null; 
        }

        /**
         * Parses the comma-separated string of no-delivery dates into a global array of Date objects.
         * Shows an error if any date is invalid.
         */
        function parseNoDeliveryDates() {
            const dateString = document.getElementById('noDeliveryDates').value.trim();
            const dateInputError = document.getElementById('dateInputError');
            blockedDates = [];
            dateInputError.classList.add('hidden');
            
            if (dateString === '') {
                return true; // No dates, no error
            }

            const dateStrings = dateString.split(',').map(s => s.trim()).filter(s => s !== '');
            let hasError = false;
            let invalidDates = [];

            dateStrings.forEach(s => {
                const date = parseDate(s);
                if (date) {
                    // Check for duplicates before adding
                    const isDuplicate = blockedDates.some(d => d.getTime() === date.getTime());
                    if (!isDuplicate) {
                        blockedDates.push(date);
                    }
                } else {
                    hasError = true;
                    invalidDates.push(s);
                }
            });

            if (hasError) {
                dateInputError.textContent = `รูปแบบวันที่ไม่ถูกต้อง: ${invalidDates.join(', ')} กรุณาใช้ DD-MM-YYYY`;
                dateInputError.classList.remove('hidden');
                // We keep the valid dates, but signal an error
                return false; 
            }
            return true;
        }

        /**
         * Checks if a given date is present in the blockedDates array.
         * @param {Date} date - The date to check (normalized to start of day).
         * @returns {boolean} True if the date is blocked.
         */
        function isBlockedDate(date) {
            const checkTime = date.getTime();
            return blockedDates.some(blockedDate => blockedDate.getTime() === checkTime);
        }

        /**
         * Helper function to add days to a Date object.
         * @param {Date} date - The starting date.
         * @param {number} days - The number of days to add/subtract.
         * @returns {Date} The new Date object.
         */
        function addDays(date, days) {
            const newDate = new Date(date.valueOf());
            newDate.setDate(newDate.getDate() + days);
            newDate.setHours(0, 0, 0, 0); // Ensure normalization
            return newDate;
        }
        
        /**
         * Helper function to get difference in days (DateA - DateB).
         * @param {Date} dateA - The later date.
         * @param {Date} dateB - The earlier date.
         * @returns {number} The difference in full days.
         */
        function dateDiffInDays(dateA, dateB) {
            const msPerDay = 1000 * 60 * 60 * 24;
            // Normalize dates to ensure only full day difference is counted
            const normA = new Date(dateA.getFullYear(), dateA.getMonth(), dateA.getDate());
            const normB = new Date(dateB.getFullYear(), dateB.getMonth(), dateB.getDate());
            
            return Math.round((normA.getTime() - normB.getTime()) / msPerDay);
        }
        
        /**
         * ค้นหาวันอังคาร (2) หรือวันพฤหัสบดี (4) ที่เร็วที่สุดถัดจากวันที่กำหนด (รวมวันนี้)
         * @param {Date} date - วันที่เริ่มต้น (วันนี้)
         * @returns {Date} วัน T/Th ที่เร็วที่สุดถัดไป (Normalized)
         */
        function findNextTTh(date) {
            let i = 0;
            const today = new Date(date.valueOf());
            today.setHours(0, 0, 0, 0);

            // JavaScript getDay(): 0=Sun, 1=Mon, 2=Tue, 3=Wed, 4=Thu, 5=Fri, 6=Sat
            while(i <= 7) { 
                let checkDate = addDays(today, i);
                let dayOfWeek = checkDate.getDay();
                if (dayOfWeek === 2 || dayOfWeek === 4) { // Tuesday (2) or Thursday (4)
                    return checkDate;
                }
                i++;
            }
            return today; // Fallback
        }

        /**
         * ค้นหาวันจันทร์ (1) ที่เร็วที่สุดถัดจากวันที่กำหนด หรือเป็นวันจันทร์ถ้าวันที่กำหนดเป็นวันจันทร์อยู่แล้ว
         * @param {Date} date - วันที่เริ่มต้น
         * @returns {Date} วันจันทร์ถัดไปที่เร็วที่สุด (Normalized)
         */
        function findNextMonday(date) {
            let nextDate = new Date(date.valueOf());
            nextDate.setHours(0, 0, 0, 0); // Normalize time
            let day = nextDate.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            let daysToAdd = 0;

            if (day !== 1) { // ถ้าไม่ใช่จันทร์ (1)
                daysToAdd = (1 + 7 - day) % 7; 
            }
            
            return addDays(nextDate, daysToAdd);
        }

        /**
         * สลับการแสดงผลของกล่องข้อความรายละเอียด และเปลี่ยนข้อความบนปุ่ม
         * @param {boolean} [forceClose=false] - If true, forces the container to close.
         */
        function toggleDetails(forceClose = false) {
            const container = document.getElementById('detailMessageContainer');
            const button = document.getElementById('toggleDetailsBtn');
            const conditionsContainer = document.getElementById('conditionsModalContainer');

            if (forceClose || container.classList.contains('active')) {
                // Hide with animation
                container.classList.remove('active');
                button.textContent = 'รายละเอียดเพิ่มเติม';
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 300); // Wait for transition to finish
            } else {
                // Ensure conditions modal is closed when opening details
                if (conditionsContainer.classList.contains('active')) {
                    toggleConditionsModal(true); // Force close conditions
                }
                
                // Show with animation
                container.classList.remove('hidden');
                setTimeout(() => {
                    container.classList.add('active');
                }, 10); // Short delay for CSS transition
                button.textContent = 'ซ่อนรายละเอียด';
            }
        }
        
        /**
         * สลับการแสดงผลของกล่องข้อความเงื่อนไข และเปลี่ยนข้อความบนปุ่ม
         * @param {boolean} [forceClose=false] - If true, forces the container to close.
         */
        function toggleConditionsModal(forceClose = false) {
            const container = document.getElementById('conditionsModalContainer');
            const button = document.getElementById('toggleConditionsBtn');
            const detailsContainer = document.getElementById('detailMessageContainer');
            
            if (forceClose || container.classList.contains('active')) {
                // Hide with animation
                container.classList.remove('active');
                button.textContent = 'เพิ่ม/แก้ไข เงื่อนไข';
                setTimeout(() => {
                    container.classList.add('hidden');
                }, 300); // Wait for transition to finish
            } else {
                // Ensure details container is closed when opening conditions
                if (detailsContainer.classList.contains('active')) {
                    toggleDetails(true); // Force close details
                }

                // Show with animation
                container.classList.remove('hidden');
                setTimeout(() => {
                    container.classList.add('active');
                }, 10); // Short delay for CSS transition
                button.textContent = 'ซ่อนเงื่อนไข';
            }
        }

        /**
         * ฟังก์ชันหลักในการคำนวณ
         */
        function calculateReorder() {
            // 0. ตรวจสอบและดึงวันที่ห้ามส่ง
            const isDateParsingValid = parseNoDeliveryDates();
            
            // ดึงค่าหลักที่บังคับ
            const soh = parseFloat(document.getElementById('soh').value);
            const usage = parseFloat(document.getElementById('usage').value);
            const lt = parseInt(document.getElementById('lt').value);
            
            // ดึงค่า Buffer LT (ค่าทางเลือก)
            const bufferLtInput = document.getElementById('bufferLt').value.trim();
            let bufferLt;

            const resultsDiv = document.getElementById('results');
            const errorMessage = document.getElementById('errorMessage');
            // Remove adjustmentWarning as the new logic is deterministic
            const adjustmentWarning = document.getElementById('adjustmentWarning'); 
            adjustmentWarning.classList.add('hidden'); 
            
            // Current time for calculation basis
            const today = new Date(); 
            today.setHours(0, 0, 0, 0); // Normalize time to start of day

            // 1. ตรวจสอบความถูกต้องของข้อมูลหลัก
            if (isNaN(soh) || isNaN(usage) || isNaN(lt) || usage <= 0 || soh < 0 || lt < 0) {
                errorMessage.innerHTML = "Error: กรุณาป้อนข้อมูล SOH, Usage, และ LT ให้ครบถ้วนและถูกต้อง (Usage ต้องมากกว่า 0 และค่าทั้งหมดต้องไม่ติดลบ)";
                errorMessage.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                document.getElementById('toggleDetailsBtn').classList.add('hidden');
                document.getElementById('toggleConditionsBtn').classList.add('hidden');
                return;
            }

            // 2. จัดการกับค่า Buffer LT
            if (bufferLtInput === '') {
                bufferLt = 0; // ถ้าเว้นว่าง ถือเป็น 0
            } else {
                const parsedBufferLt = parseInt(bufferLtInput);
                if (isNaN(parsedBufferLt) || parsedBufferLt < 0) {
                    errorMessage.innerHTML = "Error: ค่า Buffer LT ที่ป้อนต้องเป็นตัวเลขจำนวนเต็มบวก หรือเว้นว่างไว้";
                    errorMessage.classList.remove('hidden');
                    resultsDiv.classList.add('hidden');
                    document.getElementById('toggleDetailsBtn').classList.add('hidden');
                    document.getElementById('toggleConditionsBtn').classList.add('hidden');
                    return;
                }
                bufferLt = parsedBufferLt;
            }
            
            errorMessage.classList.add('hidden');
            resultsDiv.classList.remove('hidden');
            document.getElementById('toggleDetailsBtn').classList.remove('hidden');
            document.getElementById('toggleConditionsBtn').classList.remove('hidden');
            
            // 3. คำนวณ Total Month คงเหลือปัจจุบัน
            const totalMonthCurrent = soh / usage;
            
            // 4. คำนวณ Total Lead Time
            const totalLtDays = lt + bufferLt;
            
            // 5. กำหนดเป้าหมาย Total Month หลังส่งสินค้าตามเงื่อนไข LT
            let targetPostDeliveryMonths;
            if (totalLtDays >= 12 && totalLtDays <= 15) {
                targetPostDeliveryMonths = 2.0;
            } else if (totalLtDays > 15 && totalLtDays <= 30) {
                targetPostDeliveryMonths = 2.5;
            } else if (totalLtDays > 30 && totalLtDays <= 35) {
                targetPostDeliveryMonths = 3.0; // LT 34 days falls here
            } else if (totalLtDays > 35 && totalLtDays <= 65) {
                targetPostDeliveryMonths = 3.5;
            } else if (totalLtDays < 12) {
                targetPostDeliveryMonths = 2.0; 
            } else { // totalLtDays > 65
                targetPostDeliveryMonths = 3.0; 
            }
            
            // 6. คำนวณ วันสั่งซื้อที่แนะนำ (T/Th ถัดไปเสมอ)
            const finalOrderDate = findNextTTh(today); 
            finalOrderDate.setHours(0, 0, 0, 0); 

            // 7. คำนวณวันส่งสินค้าเริ่มต้น (Order Date + Total LT)
            const initialDeliveryDate = addDays(finalOrderDate, totalLtDays);
            
            // 8. ปรับวันส่งสินค้าให้เป็นวันจันทร์ถัดไปที่เร็วที่สุด
            let fixedDeliveryDate = findNextMonday(initialDeliveryDate); 
            
            // ** 9. NEW LOGIC: ตรวจสอบและปรับวันส่งมอบตามวันที่ห้ามส่ง (Blocked Dates) **
            let adjustmentDays = 0;
            const originalFixedMonday = new Date(fixedDeliveryDate.valueOf()); 
            let adjusted = false;

            if (isBlockedDate(fixedDeliveryDate)) {
                adjusted = true;
                let tempDate = new Date(fixedDeliveryDate.valueOf()); 
                
                // Start searching backward from the day before the blocked date, moving backward.
                for (let i = 1; i <= 30; i++) { // Search up to 30 days back
                    tempDate = addDays(originalFixedMonday, -i); 
                    const dayOfWeek = tempDate.getDay();

                    // Valid delivery days are Monday (1) and Thursday (4)
                    // The user's examples show a preference for M/Th over Sunday.
                    if (dayOfWeek === 1 || dayOfWeek === 4) { 
                        if (!isBlockedDate(tempDate)) {
                            // Found the nearest available preceding M or Th
                            fixedDeliveryDate = tempDate;
                            adjustmentDays = i;
                            break;
                        }
                    }
                }
                // If loop finishes without finding an unblocked M/Th, fixedDeliveryDate remains the last checked date
            }
            // -------------------------------------------------------------
            
            // 10. คำนวณ SOH ที่เหลือในวัน Delivery
            const daysToDelivery = dateDiffInDays(fixedDeliveryDate, today);
            const usagePerDay = usage / DAYS_PER_MONTH;
            const consumption = daysToDelivery * usagePerDay;
            const sohAtDelivery = Math.max(0, soh - consumption); // SOH ไม่ต่ำกว่า 0

            // 11. คำนวณปริมาณที่ต้องสั่งซื้อเพื่อให้ได้ Target Post-Delivery Months
            const targetStockUnits = targetPostDeliveryMonths * usage;
            let orderQty = targetStockUnits - sohAtDelivery;
            orderQty = Math.max(0, orderQty); 
            orderQty = Math.ceil(orderQty); 

            // เก็บค่าก่อนปัดเศษสำหรับแสดงในรายละเอียด
            const initialOrderQty = orderQty; 
            
            // --- LOGIC: ปรับให้เป็นเลขคู่ ถ้าไม่ใช่ศูนย์ ---
            if (orderQty > 0 && orderQty % 2 !== 0) {
                orderQty += 1; 
            }
            // --------------------------------------------------

            // 12. คำนวณ Total Month หลังส่งสินค้า (เพื่อยืนยันว่าตรงตามเป้าหมาย)
            const finalStockAfterDelivery = sohAtDelivery + orderQty;
            const postDeliveryMonth = finalStockAfterDelivery / usage;

            // 13. เตรียมข้อความรายละเอียดและแสดงผล
            const orderDateText = formatDateDDMMYYYY(finalOrderDate);
            const deliveryDateText = formatDateDDMMYYYY(fixedDeliveryDate);

            document.getElementById('orderDate').innerHTML = orderDateText;
            document.getElementById('deliveryDate').innerHTML = deliveryDateText;
            document.getElementById('orderQuantity').textContent = `${orderQty.toFixed(0)} หน่วย`;
            document.getElementById('totalMonthCurrent').textContent = `${totalMonthCurrent.toFixed(2)} เดือน`;
            document.getElementById('postDeliveryMonth').textContent = `${postDeliveryMonth.toFixed(2)} เดือน`;
            document.getElementById('targetMonthDisplay').textContent = `${targetPostDeliveryMonths.toFixed(1)}`;
            
            // For detail message (using Thai full format)
            const thaiOptions = { day: 'numeric', month: 'long', year: 'numeric' };
            const orderDateStringThai = finalOrderDate.toLocaleDateString('th-TH', thaiOptions);
            const deliveryDateStringThai = fixedDeliveryDate.toLocaleDateString('th-TH', thaiOptions);
            const orderDayName = finalOrderDate.toLocaleDateString('th-TH', { weekday: 'long' });
            
            // Recalculate Initial Delivery Date for display in details (before Monday fix)
            const initialDeliveryDateForDisplay = addDays(finalOrderDate, totalLtDays);
            const initialDeliveryDateStringThai = initialDeliveryDateForDisplay.toLocaleDateString('th-TH', thaiOptions);

            // --- DETAIL MESSAGE STRUCTURE ---
            let detailMessage = ``;
            
            // Summary of Inputs
            detailMessage += `<u>สรุปข้อมูลนำเข้าสำหรับการคำนวณ</u><br>`;
            detailMessage += `- สินค้าคงคลัง (SOH): ${soh.toFixed(2)} หน่วย<br>`;
            detailMessage += `- ปริมาณการใช้ (Usage): ${usage.toFixed(2)} หน่วย/เดือน<br>`;
            detailMessage += `- Lead Time รวม (LT+Buffer): ${lt} + ${bufferLt} = <b>${totalLtDays} วัน</b><br>`;
            detailMessage += `- เป้าหมาย Total Month หลังรับสินค้า: <b>${targetPostDeliveryMonths.toFixed(1)} เดือน</b><br>`;
            
            if (blockedDates.length > 0) {
                detailMessage += `- วันที่ห้ามส่งสินค้า: <b>${blockedDates.map(formatDateDDMMYYYY).join(', ')}</b><br>`;
            }
            detailMessage += `<hr class="border-gray-700 my-2">`;


            // Step 1: Timeline and Consumption
            detailMessage += `<u>ขั้นตอนที่ 1: การคาดการณ์สินค้าคงคลัง ณ วันรับสินค้า</u><br>`;
            detailMessage += `- วันสั่งซื้อแนะนำ (T/Th ถัดไป): ${orderDateStringThai} (${orderDayName})<br>`;
            
            // Original Fixed Monday (before adjustment)
            const originalFixedMonDateStringThai = originalFixedMonday.toLocaleDateString('th-TH', thaiOptions);
            const originalFixedMonDayName = originalFixedMonday.toLocaleDateString('th-TH', { weekday: 'long' });

            let deliveryProcessNote = '';
            // Determine if the initial LT delivery date was fixed to the next Monday
            if (dateDiffInDays(originalFixedMonday, initialDeliveryDateForDisplay) > 0) {
                 deliveryProcessNote = `วันส่งสินค้าตาม LT (${initialDeliveryDateStringThai}) ถูกปรับเป็นวันจันทร์ถัดไป คือ ${originalFixedMonDateStringThai}<br>`;
            } else {
                 deliveryProcessNote = `วันส่งสินค้าตาม LT (${initialDeliveryDateStringThai}) ตรงกับวันจันทร์ที่ ${originalFixedMonDateStringThai}<br>`;
            }
            detailMessage += `- ${deliveryProcessNote}`;
            
            // Add note about blocked date adjustment
            if (adjusted) { 
                const fixedDateDayName = fixedDeliveryDate.toLocaleDateString('th-TH', { weekday: 'long' });
                
                detailMessage += `<span class="text-red-400 font-bold">** การปรับเงื่อนไข:</span> วันที่ ${originalFixedMonDateStringThai} (${originalFixedMonDayName}) ตรงกับวันที่ห้ามส่ง!<br>`;
                detailMessage += `- ระบบจึงค้นหาวันส่งสินค้าที่ว่างย้อนหลัง โดยมีลำดับความสำคัญคือ **วันจันทร์ (Mon)** และ **วันพฤหัสบดี (Thu)**<br>`;
                detailMessage += `- วันรับสินค้าสุดท้ายที่ปรับแล้ว: <b>${deliveryDateStringThai} (${fixedDateDayName})</b> (ปรับย้อนหลัง ${adjustmentDays} วัน)<br>`;
                 
            } 

            detailMessage += `- จำนวนวันรอสินค้า (จากวันนี้ถึงวันรับของ): <b>${daysToDelivery} วัน</b><br>`;
            detailMessage += `- ปริมาณที่ใช้ไประหว่างรอ: (${usage.toFixed(2)} / ${DAYS_PER_MONTH.toFixed(2)} วัน) x ${daysToDelivery} วัน = ${consumption.toFixed(2)} หน่วย<br>`;
            detailMessage += `- สินค้าคงเหลือ ณ วันรับสินค้า (SOH At Delivery): SOH (${soh.toFixed(2)}) - ใช้ไป (${consumption.toFixed(2)}) = <span class="text-yellow-400 font-bold">${sohAtDelivery.toFixed(2)} หน่วย</span><br>`;
            detailMessage += `<hr class="border-gray-700 my-2">`;


            // Step 2: Ordering Logic
            detailMessage += `<u>ขั้นตอนที่ 2: การตัดสินใจสั่งซื้อ</u><br>`;
            detailMessage += `- เป้าหมายสต็อกที่ต้องการ: ${targetPostDeliveryMonths.toFixed(1)} เดือน x ${usage.toFixed(2)} หน่วย/เดือน = <b>${targetStockUnits.toFixed(2)} หน่วย</b><br>`;
            detailMessage += `- SOH ณ วันรับสินค้า: ${sohAtDelivery.toFixed(2)} หน่วย<br>`;

            if (initialOrderQty > 0) { 
                 detailMessage += `- ปริมาณที่ต้องสั่งซื้อขั้นต่ำ (ปัดขึ้น): เป้าหมาย (${targetStockUnits.toFixed(2)}) - SOH ณ วันรับของ (${sohAtDelivery.toFixed(2)}) = ${initialOrderQty.toFixed(0)} หน่วย<br>`;
                 
                 if (initialOrderQty !== orderQty) {
                    detailMessage += `- การปรับ: ปริมาณสั่งซื้อถูกปรับจาก ${initialOrderQty.toFixed(0)} เป็น <b><span class="text-cyan-400 font-bold">${orderQty.toFixed(0)} หน่วย</span></b> เพื่อให้เป็นเลขคู่ตามข้อกำหนด<br>`;
                 }
                 
                 detailMessage += `- ปริมาณสั่งซื้อสุดท้าย: <b><span class="text-cyan-400 font-bold">${orderQty.toFixed(0)} หน่วย</span></b><br>`;

            } else {
                 detailMessage += `- ผลลัพธ์: ปริมาณที่ต้องสั่งซื้อ = <b><span class="text-cyan-400 font-bold">0 หน่วย</span></b> (สต็อกปัจจุบันเพียงพอ)<br>`;
            }
            
            detailMessage += `- Total Month หลังส่งมอบ: (${sohAtDelivery.toFixed(2)} + ${orderQty.toFixed(0)}) / ${usage.toFixed(2)} = <b><span class="text-green-400 font-bold">${postDeliveryMonth.toFixed(2)} เดือน</span></b>`;
            
            // 14. แสดงผลรายละเอียดและจัดการปุ่ม/คำเตือน
            document.getElementById('detailMessage').innerHTML = detailMessage;
            
            // Reset detail/conditions visibility (force close both after calculation)
            // Use forceClose=true in the function calls
            toggleDetails(true);
            
            // Only force close conditions modal if there's NO date parsing error, so user can fix it
            if (document.getElementById('dateInputError').classList.contains('hidden')) {
                toggleConditionsModal(true);
            } else {
                // If there's an error, force open the conditions modal so user can see and fix
                toggleConditionsModal(false); 
            }

            // ตรวจสอบสถานะสต็อกและแสดงคำเตือนเพิ่มเติม
            if (totalMonthCurrent < 1.0) {
                 errorMessage.innerHTML = "คำเตือน: สต็อกปัจจุบันต่ำกว่า 1 เดือน! ควรเร่งสั่งซื้อโดยด่วน";
                 errorMessage.classList.remove('hidden');
            } else if (orderQty === 0) {
                 // Only show 'sufficient stock' message if no date parsing error is present
                 if (document.getElementById('dateInputError').classList.contains('hidden')) {
                    errorMessage.innerHTML = "ข้อมูล: ไม่ต้องสั่งซื้อในตอนนี้ สต็อกปัจจุบันเพียงพอต่อความต้องการถึงวันส่งมอบสินค้าครั้งถัดไป";
                    errorMessage.classList.remove('hidden');
                 }
            } else {
                 // Only hide if there's no date parsing error
                 if (document.getElementById('dateInputError').classList.contains('hidden')) {
                     errorMessage.classList.add('hidden');
                 }
            }

        }

        /**
         * ตั้งค่าตัวฟังเหตุการณ์สำหรับปุ่ม Enter
         */
        function setupEventListeners() {
            const inputIds = ['soh', 'usage', 'lt', 'bufferLt'];
            inputIds.forEach(id => {
                const inputElement = document.getElementById(id);
                if (inputElement) {
                    inputElement.addEventListener('keydown', function(event) {
                        // Check for the Enter key
                        if (event.key === 'Enter') {
                            event.preventDefault(); // ป้องกันการทำงานเริ่มต้น เช่น การย้ายไปยัง Input ถัดไป
                            calculateReorder();
                        }
                    });
                }
            });
        }

        // Run calculation and setup listeners on load.
        window.onload = function() {
            // Setup Enter key listener
            setupEventListeners();
            // Run initial calculation (which will show the error/empty state now)
            calculateReorder();
        };
    </script>
</body>
</html>
